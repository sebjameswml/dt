This is code copied from CUPS.
